# -*- coding: utf-8 -*-
from datetime import datetime

# Form implementation generated from reading ui file 'edit_patient_data_page.ui'
#
# Created by: PyQt5 UI code generator 5.15.9
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtCore import pyqtSignal
from PyQt5.QtGui import QIntValidator

from components.handle_error_message import HandleErrorMessage
from utils.common_utils import fetch_data, has_empty_or_null_value


class EditPatientPage(QtWidgets.QDialog, HandleErrorMessage):
    dataEntered = pyqtSignal(str, str, str)

    def __init__(self, patient_id=None, parent=None):
        super(EditPatientPage, self).__init__(parent)
        self.parent = parent
        self.patient_id = patient_id
        self.setupUi()

    def setupUi(self):
        try:
            self.setObjectName("EditPatientPage")
            self.resize(561, 520)
            self.closeButton = QtWidgets.QPushButton(self)
            self.closeButton.setGeometry(QtCore.QRect(170, 420, 111, 41))
            font = QtGui.QFont()
            font.setPointSize(12)
            self.closeButton.setFont(font)
            self.closeButton.setStyleSheet("background-color: rgb(255, 255, 255); color: rgb(0, 170, 255)")
            self.closeButton.setObjectName("closeButton")
            self.saveButton = QtWidgets.QPushButton(self)
            self.saveButton.setGeometry(QtCore.QRect(30, 420, 111, 41))
            font = QtGui.QFont()
            font.setPointSize(12)
            self.saveButton.setFont(font)
            self.saveButton.setStyleSheet("background-color: rgb(255, 255, 255); color: rgb(0, 170, 255)")
            self.saveButton.setObjectName("saveButton")
            self.editPatientLabel = QtWidgets.QLabel(self)
            self.editPatientLabel.setGeometry(QtCore.QRect(30, 20, 131, 25))
            font = QtGui.QFont()
            font.setPointSize(12)
            self.editPatientLabel.setFont(font)
            self.editPatientLabel.setStyleSheet("color:#757575")
            self.editPatientLabel.setFrameShadow(QtWidgets.QFrame.Plain)
            self.editPatientLabel.setObjectName("editPatientLabel")
            self.widget_2 = QtWidgets.QWidget(self)
            self.widget_2.setGeometry(QtCore.QRect(30, 60, 511, 341))
            self.widget_2.setAutoFillBackground(True)
            self.widget_2.setObjectName("widget_2")
            self.gridLayoutWidget_3 = QtWidgets.QWidget(self.widget_2)
            self.gridLayoutWidget_3.setGeometry(QtCore.QRect(0, 0, 511, 341))
            self.gridLayoutWidget_3.setObjectName("gridLayoutWidget_3")
            self.gridLayout_3 = QtWidgets.QGridLayout(self.gridLayoutWidget_3)
            self.gridLayout_3.setContentsMargins(0, 0, 0, 0)
            self.gridLayout_3.setObjectName("gridLayout_3")
            self.guardianLineEdit = QtWidgets.QLineEdit(self.gridLayoutWidget_3)
            self.guardianLineEdit.setEnabled(True)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.guardianLineEdit.setFont(font)
            self.guardianLineEdit.setStyleSheet("color:#757575")
            self.guardianLineEdit.setObjectName("guardianLineEdit")
            self.gridLayout_3.addWidget(self.guardianLineEdit, 4, 1, 1, 1)
            self.dateOfBirthLabel = QtWidgets.QLabel(self.gridLayoutWidget_3)
            sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
            sizePolicy.setHorizontalStretch(0)
            sizePolicy.setVerticalStretch(0)
            sizePolicy.setHeightForWidth(self.dateOfBirthLabel.sizePolicy().hasHeightForWidth())
            self.dateOfBirthLabel.setSizePolicy(sizePolicy)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.dateOfBirthLabel.setFont(font)
            self.dateOfBirthLabel.setStyleSheet("color:#757575")
            self.dateOfBirthLabel.setObjectName("dateOfBirthLabel")
            self.gridLayout_3.addWidget(self.dateOfBirthLabel, 3, 0, 1, 1)
            self.contactNumberLabel = QtWidgets.QLabel(self.gridLayoutWidget_3)
            sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
            sizePolicy.setHorizontalStretch(0)
            sizePolicy.setVerticalStretch(0)
            sizePolicy.setHeightForWidth(self.contactNumberLabel.sizePolicy().hasHeightForWidth())
            self.contactNumberLabel.setSizePolicy(sizePolicy)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.contactNumberLabel.setFont(font)
            self.contactNumberLabel.setStyleSheet("color:#757575")
            self.contactNumberLabel.setObjectName("contactNumberLabel")
            self.gridLayout_3.addWidget(self.contactNumberLabel, 5, 0, 1, 1)
            self.idLineEdit = QtWidgets.QLineEdit(self.gridLayoutWidget_3)
            self.idLineEdit.setEnabled(False)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.idLineEdit.setFont(font)
            self.idLineEdit.setStyleSheet("color:#757575")
            self.idLineEdit.setReadOnly(True)
            self.idLineEdit.setObjectName("idLineEdit")
            self.gridLayout_3.addWidget(self.idLineEdit, 0, 1, 1, 1)
            self.dateEdit = QtWidgets.QDateEdit(self.gridLayoutWidget_3)
            self.dateEdit.setEnabled(False)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.dateEdit.setFont(font)
            self.dateEdit.setStyleSheet("color:#757575")
            self.dateEdit.setReadOnly(True)
            self.dateEdit.setObjectName("dateEdit")
            self.gridLayout_3.addWidget(self.dateEdit, 3, 1, 1, 1)
            self.genderLineEdit = QtWidgets.QLineEdit(self.gridLayoutWidget_3)
            self.genderLineEdit.setEnabled(False)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.genderLineEdit.setFont(font)
            self.genderLineEdit.setStyleSheet("color:#757575")
            self.genderLineEdit.setReadOnly(True)
            self.genderLineEdit.setObjectName("genderLineEdit")
            self.gridLayout_3.addWidget(self.genderLineEdit, 2, 1, 1, 1)
            self.idLabel = QtWidgets.QLabel(self.gridLayoutWidget_3)
            sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
            sizePolicy.setHorizontalStretch(0)
            sizePolicy.setVerticalStretch(0)
            sizePolicy.setHeightForWidth(self.idLabel.sizePolicy().hasHeightForWidth())
            self.idLabel.setSizePolicy(sizePolicy)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.idLabel.setFont(font)
            self.idLabel.setStyleSheet("color:#757575")
            self.idLabel.setObjectName("idLabel")
            self.gridLayout_3.addWidget(self.idLabel, 0, 0, 1, 1)
            self.nameLineEdit = QtWidgets.QPlainTextEdit(self.gridLayoutWidget_3)
            self.nameLineEdit.setEnabled(False)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.nameLineEdit.setFont(font)
            self.nameLineEdit.setStyleSheet("color:#757575")
            self.nameLineEdit.setReadOnly(True)
            self.nameLineEdit.setObjectName("nameLineEdit")
            self.gridLayout_3.addWidget(self.nameLineEdit, 1, 1, 1, 1)
            self.genderLabel = QtWidgets.QLabel(self.gridLayoutWidget_3)
            sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
            sizePolicy.setHorizontalStretch(0)
            sizePolicy.setVerticalStretch(0)
            sizePolicy.setHeightForWidth(self.genderLabel.sizePolicy().hasHeightForWidth())
            self.genderLabel.setSizePolicy(sizePolicy)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.genderLabel.setFont(font)
            self.genderLabel.setStyleSheet("color:#757575")
            self.genderLabel.setObjectName("genderLabel")
            self.gridLayout_3.addWidget(self.genderLabel, 2, 0, 1, 1)
            self.nameLabel = QtWidgets.QLabel(self.gridLayoutWidget_3)
            sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
            sizePolicy.setHorizontalStretch(0)
            sizePolicy.setVerticalStretch(0)
            sizePolicy.setHeightForWidth(self.nameLabel.sizePolicy().hasHeightForWidth())
            self.nameLabel.setSizePolicy(sizePolicy)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.nameLabel.setFont(font)
            self.nameLabel.setStyleSheet("color:#757575")
            self.nameLabel.setObjectName("nameLabel")
            self.gridLayout_3.addWidget(self.nameLabel, 1, 0, 1, 1)
            self.contactNumberLineEdit = QtWidgets.QLineEdit(self.gridLayoutWidget_3)
            self.contactNumberLineEdit.setEnabled(True)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.contactNumberLineEdit.setFont(font)
            self.contactNumberLineEdit.setStyleSheet("color:#757575")
            self.contactNumberLineEdit.setObjectName("contactNumberLineEdit")
            int_validator = QIntValidator(self)
            self.contactNumberLineEdit.setValidator(int_validator)
            self.gridLayout_3.addWidget(self.contactNumberLineEdit, 5, 1, 1, 1)
            self.guardianLabel = QtWidgets.QLabel(self.gridLayoutWidget_3)
            sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
            sizePolicy.setHorizontalStretch(0)
            sizePolicy.setVerticalStretch(0)
            sizePolicy.setHeightForWidth(self.guardianLabel.sizePolicy().hasHeightForWidth())
            self.guardianLabel.setSizePolicy(sizePolicy)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.guardianLabel.setFont(font)
            self.guardianLabel.setStyleSheet("color:#757575")
            self.guardianLabel.setObjectName("guardianLabel")
            self.gridLayout_3.addWidget(self.guardianLabel, 4, 0, 1, 1)
            self.addressLabel = QtWidgets.QLabel(self.gridLayoutWidget_3)
            sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
            sizePolicy.setHorizontalStretch(0)
            sizePolicy.setVerticalStretch(0)
            sizePolicy.setHeightForWidth(self.addressLabel.sizePolicy().hasHeightForWidth())
            self.addressLabel.setSizePolicy(sizePolicy)
            font = QtGui.QFont()
            font.setPointSize(12)
            self.addressLabel.setFont(font)
            self.addressLabel.setStyleSheet("color:#757575")
            self.addressLabel.setObjectName("addressLabel")
            self.gridLayout_3.addWidget(self.addressLabel, 6, 0, 1, 1)
            self.addressPlainTextEdit = QtWidgets.QPlainTextEdit(self.gridLayoutWidget_3)
            self.addressPlainTextEdit.setObjectName("addressPlainTextEdit")
            font = QtGui.QFont()
            font.setPointSize(12)
            self.addressPlainTextEdit.setFont(font)
            self.addressPlainTextEdit.setStyleSheet("color:#757575")
            self.gridLayout_3.addWidget(self.addressPlainTextEdit, 6, 1, 1, 1)

            self.addErrorLabel(QtCore.QRect(30, 60, 411, 25), self)

            self.retranslateUi()
            QtCore.QMetaObject.connectSlotsByName(self)
            self.setValues()

            self.closeButton.clicked.connect(self.close)
            self.saveButton.clicked.connect(self.save)
        except Exception as e:
            print(e)

    def retranslateUi(self):
        _translate = QtCore.QCoreApplication.translate
        self.setWindowTitle(_translate("EditPatientPage", "Edit Patient Page"))
        self.closeButton.setText(_translate("EditPatientPage", "Close"))
        self.saveButton.setText(_translate("EditPatientPage", "Save"))
        self.editPatientLabel.setText(_translate("EditPatientPage", "Edit Patient Details"))
        self.dateOfBirthLabel.setText(_translate("EditPatientPage", "Date of Birth"))
        self.contactNumberLabel.setText(_translate("EditPatientPage", "Contact Number*"))
        self.idLabel.setText(_translate("EditPatientPage", "Id"))
        self.genderLabel.setText(_translate("EditPatientPage", "Gender"))
        self.nameLabel.setText(_translate("EditPatientPage", "Name"))
        self.guardianLabel.setText(_translate("EditPatientPage", "Guardian*"))
        self.addressLabel.setText(_translate("EditPatientPage", "Address*"))

    def setValues(self):
        patient_data = fetch_data("patients/data", {"_id": self.patient_id})
        self.idLineEdit.setText(str(self.patient_id))
        self.nameLineEdit.setPlainText(patient_data["patient_name"])
        self.genderLineEdit.setText(patient_data["gender"])
        self.dateEdit.setDate(datetime.fromisoformat(patient_data["date_of_birth"]['$date'][:-1]).date())
        self.guardianLineEdit.setText(patient_data["guardian"])
        self.addressPlainTextEdit.setPlainText(patient_data["address"])
        self.contactNumberLineEdit.setText(patient_data["contact_number"])

    def save(self):
        guardian = self.guardianLineEdit.text()
        contact_number = self.contactNumberLineEdit.text()
        address = self.addressPlainTextEdit.toPlainText()
        patient_id = self.patient_id
        if patient_id:
            query_data = {
                "_id": patient_id,
            }
            update_data = {
                "guardian": guardian,
                "contact_number": contact_number,
                "address": address
            }
            if not has_empty_or_null_value(update_data):
                self.handlePutRequest("patients/update_data", query_data, update_data)
                if self.error.text() == "Record updated successfully":
                    self.dataEntered.emit(guardian, contact_number, address)
                    self.accept()
            else:
                self.displayErrorMessage(True, "Inputs marked with * are required")
